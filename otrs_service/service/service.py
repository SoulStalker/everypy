import calendar
import datetime
import random

from loguru import logger
from sqlalchemy import select

from otrs_service.app.constants import TgAnswer, KafkaTopics
from otrs_service.app.db import DataAnalyzer, session_maker
from otrs_service.app.db.models import Ticket
from otrs_service.app.last_id import load_last_id, save_last_id
from otrs_service.infrastructure.producer import send_message


async def get_message(analyzer, period):
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Ç–µ–ª–µ–≥–∏ —Å–æ —Å–º–∞–π–ª–∏–∫–∞–º–∏
    :param analyzer:
    :param period:
    :return:
    """
    strongs = []
    poos = {}

    strong = '   \U0001F4AA\n'
    good = '   \U0001F44D\n'
    little = '   \U0001F90F\n'
    poo = '   \U0001F4A9\n'
    if period == '—Å–µ–≥–æ–¥–Ω—è':
        multiplier = 1
        await analyzer.get_results()
    elif period == '–º–µ—Å—è—Ü':
        multiplier = 10
        await analyzer.get_month_results()
    message = f'–ó–∞ {period} –∑–∞–∫—Ä—ã–ª–∏ –∑–∞—è–≤–∫–∏: \n\n'
    for result in analyzer.results:
        agent = f' - {result[0]} {result[1]} - '
        tickets = result[2]
        message += agent
        message += str(tickets)
        if tickets >= 15 * multiplier:
            message += strong
            strongs.append(result[0])
        elif tickets >= 10 * multiplier:
            message += good
        elif tickets >= 5 * multiplier:
            message += little
        else:
            message += poo
            poos.setdefault(result[0], result[2])
    if len(poos) > 0:
        hero = min(poos.items(), key=lambda x: x[1])
        # end_word = bad_work(hero[0])
        end_word = TgAnswer.BAD_BOY.value
    else:
        # end_word = '–ù–∞–¥–æ –∂–µ –∫–∞–∫ –æ—Ç—Ä–∞–±–æ—Ç–∞–ª–∏, –Ω–∏ –æ–¥–Ω–æ–π –∫–∞–∫–∞—Ö–∏'
        end_word = TgAnswer.GOOD_BOY.value
    if len(strongs) > 0:
        # super_hero = max(strongs, key=lambda x: x[1])
        # end_word = well_done(super_hero)
        end_word = TgAnswer.GOOD_BOY.value
    return message, end_word


def well_done(username):
    mess = [
        f"–°–ø–∞—Å–∏–±–æ, {username}, –∑–∞ —Ç–æ, —á—Ç–æ –Ω–µ –¥–∞–µ—Ç –Ω–∞—à–∏–º –∫–æ–º–ø—å—é—Ç–µ—Ä–∞–º –ø–æ–º–µ—Ä–µ—Ç—å –º–æ–ª—á–∞.",
        f"–ù–∞—à–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–æ—Ö–æ–∂–∞ –Ω–∞ —á–∞—à–∫—É –∫–æ—Ñ–µ - –æ–Ω–∞ –≤—Å–µ–≥–¥–∞ —Ä—è–¥–æ–º –∏ –¥–µ–ª–∞–µ—Ç –¥–µ–Ω—å –ª—É—á—à–µ. –ë–ª–∞–≥–æ–¥–∞—Ä–∏–º {username}!",
        f"{username} - –∫–∞–∫ –Ω–∏–Ω–¥–∑—è –≤ –º–∏—Ä–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏. –ü—Ä–æ–±–ª–µ–º—ã –ø—Ä–æ—Å—Ç–æ –∏—Å—á–µ–∑–∞—é—Ç, –∫–æ–≥–¥–∞ –æ–Ω –≤ –¥–µ–ª–µ!",
        f"–° –Ω–∞—à–∏–º {username} –Ω–µ—Ç —Å—Ç—Ä–∞—Ö–∞ –ø–µ—Ä–µ–¥ –º–∞–≥–∏—á–µ—Å–∫–∏–º–∏ —Å–ª–æ–≤–∞–º–∏ '404' –∏ '–æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞'!",
        f"{username} –Ω–µ –Ω—É–∂–Ω—ã –∫—Ä–∞—Å–Ω—ã–µ –º–∞–Ω—Ç–∏–∏ - –µ–≥–æ –∫–æ—Å—Ç—é–º —Ç–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Å–º–æ—Ç—Ä–∏—Ç—Å—è –ª—É—á—à–µ!",
        f"{username} –Ω–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –≥–æ–ª–æ–≤–æ–ª–æ–º–æ–∫. –ù–∞ —á—Ç–æ –±—ã –º—ã –¥–µ–ª–∞–ª–∏ –±–µ–∑ –Ω–µ–≥–æ?",
        f"–ö—Ç–æ-—Ç–æ –ø–æ–∑–≤–æ–Ω–∏–ª –∫—Ä–∞—Å–Ω–æ–π –∫–Ω–æ–ø–∫–µ? –ê –Ω–µ—Ç, —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ {username}, –ø—Ä–∏—Ö–æ–¥—è—â–∏–π –Ω–∞ –ø–æ–º–æ—â—å!",
        f"–ü–æ—Ö–æ–∂–µ, {username} —É–∑–Ω–∞–ª —Å–µ–∫—Ä–µ—Ç—ã –º–∞–≥–∏–∏ IT –∏ —â–µ–ª–∫–∞–µ—Ç –ø–∞–ª—å—Ü–∞–º–∏, —á—Ç–æ–±—ã –≤—Å–µ —Ä–∞–±–æ—Ç–∞–ª–æ!",
        f"{username} ‚Äî –Ω–∞—à —Ü–∏—Ñ—Ä–æ–≤–æ–π —Å—É–ø–µ—Ä–≥–µ—Ä–æ–π. –î–∞–∂–µ –ö–∞–ø–∏—Ç–∞–Ω –ê–º–µ—Ä–∏–∫–∞ –∑–∞–≤–∏–¥—É–µ—Ç –µ–≥–æ —â–∏—Ç—É –æ—Ç –±–∞–≥–æ–≤!",
        f"–°–ø–∞—Å–∏–±–æ, {username}, –∑–∞ —Ç–æ, —á—Ç–æ –ø—Ä–µ–≤—Ä–∞—â–∞–µ—à—å –Ω–∞—à–∏ ‚Äò–æ—à–∏–±–∫–∏‚Äô –≤ ‚Äò–æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç—ã‚Äô!",
        f"{username} ‚Äî –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π, –∫—Ç–æ –ø–æ–Ω–∏–º–∞–µ—Ç, —á—Ç–æ ‚Äò–ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞‚Äô ‚Äî —ç—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ —Å–æ–≤–µ—Ç, –∞ –æ–±—Ä–∞–∑ –∂–∏–∑–Ω–∏!",
        f"–ï—Å–ª–∏ –±—ã –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –±—ã–ª —Ç–µ–º–Ω—ã–º –ª–µ—Å–æ–º, {username} –±—ã–ª –±—ã –Ω–∞—à–∏–º GPS —Å –≤–µ—á–Ω—ã–º –∑–∞—Ä—è–¥–æ–º!",
        f"{username} –Ω–µ –ø—Ä–æ—Å—Ç–æ —á–∏–Ω–∏—Ç —Å–µ—Ä–≤–µ—Ä–∞ ‚Äî –æ–Ω –≤–æ—Å–∫—Ä–µ—à–∞–µ—Ç –∏—Ö, –∫–∞–∫ IT-–Ω–µ–∫—Ä–æ–º–∞–Ω—Ç!",
        f"–ù–∞—à {username} –Ω–∞—Å—Ç–æ–ª—å–∫–æ –∫—Ä—É—Ç, —á—Ç–æ –¥–∞–∂–µ –±–∏–Ω–∞—Ä–Ω—ã–π –∫–æ–¥ —à–µ–ø—á–µ—Ç –µ–º—É —Å–ø–∞—Å–∏–±–æ!",
        f"{username} ‚Äî —ç—Ç–æ –∫–∞–∫ –∞–Ω—Ç–∏–≤–∏—Ä—É—Å, –Ω–æ –¥–ª—è —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º. –ò –¥–∞, –æ–Ω –±–µ—Å–ø–ª–∞—Ç–Ω–æ –Ω–µ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–µ—Ç—Å—è!",
        f"–ö–æ–≥–¥–∞ —É –Ω–∞—Å –ø–∞–¥–∞–µ—Ç —Å–µ—Ä–≤–µ—Ä, {username} –Ω–µ –±–µ–∂–∏—Ç ‚Äî –æ–Ω –ø—Ä–æ—Å—Ç–æ –ª–µ—Ç–∏—Ç –Ω–∞ –∫—Ä—ã–ª—å—è—Ö SSH!",
        f"–°–ø–∞—Å–∏–±–æ, {username}, –∑–∞ —Ç–æ, —á—Ç–æ —Ç—ã ‚Äî –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞, –ø–æ –∫–æ—Ç–æ—Ä–æ–π –º—ã –Ω–µ –ø–µ—Ä–µ—à–ª–∏ –Ω–∞ ‚Äò–±—É–º–∞–∂–Ω—ã–π –æ—Ñ–∏—Å‚Äô!",
        f"{username} –∑–Ω–∞–µ—Ç –ø–∞—Ä–æ–ª—å –æ—Ç –º–∞—Ç—Ä–∏—Ü—ã. –ù–æ, –∫ —Å—á–∞—Å—Ç—å—é, –æ–Ω –Ω–∞ –Ω–∞—à–µ–π —Å—Ç–æ—Ä–æ–Ω–µ!",
        f"–ï—Å–ª–∏ –±—ã —É {username} –±—ã–ª –∫—Ä–∏–ø—Ç–æ–Ω–∏—Ç, —ç—Ç–æ –±—ã–ª–∏ –±—ã –Ω–µ—Ä–∞–±–æ—Ç–∞—é—â–∏–µ –ø–∞—Ç—á–∏!",
        f"{username} ‚Äî —ç—Ç–æ –∫–∞–∫ Ctrl+Alt+Del, –Ω–æ –¥–ª—è –≤—Å–µ–π –Ω–∞—à–µ–π –∫–æ–º–ø–∞–Ω–∏–∏!",
        f"–ù–∞—à {username} –Ω–∞—Å—Ç–æ–ª—å–∫–æ –±—ã—Å—Ç—Ä, —á—Ç–æ –¥–∞–∂–µ –ø–∏–Ω–≥ –µ–º—É –∑–∞–≤–∏–¥—É–µ—Ç!",
        f"–°–ø–∞—Å–∏–±–æ, {username}, –∑–∞ —Ç–æ, —á—Ç–æ —Ç—ã ‚Äî –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π, –∫—Ç–æ –ø–æ–Ω–∏–º–∞–µ—Ç, —á—Ç–æ ‚Äò—ç—Ç–æ –Ω–µ –±–∞–≥, —ç—Ç–æ —Ñ–∏—á–∞‚Äô ‚Äî –Ω–µ —à—É—Ç–∫–∞!",
        f"{username} –Ω–µ —Å–ø–∏—Ç. –û–Ω –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ —Ä–µ–∂–∏–º –æ–∂–∏–¥–∞–Ω–∏—è!",
        f"–ï—Å–ª–∏ –±—ã —É {username} –±—ã–ª –¥–µ–≤–∏–∑, —ç—Ç–æ –±—ã–ª–æ –±—ã: ‚Äò–Ø –Ω–µ –≤–æ–ª—à–µ–±–Ω–∏–∫, —è –ø—Ä–æ—Å—Ç–æ –∑–Ω–∞—é, –≥–¥–µ –∏—Å–∫–∞—Ç—å –ª–æ–≥–∏‚Äô!",
        f"{username} ‚Äî —ç—Ç–æ –∫–∞–∫ –æ–±–ª–∞–∫–æ, –Ω–æ –±–µ–∑ –ª–∏—à–Ω–∏—Ö –¥–æ–∂–¥–µ–π –∏ —Å –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –∞–ø—Ç–∞–π–º–æ–º!",
        f"–ù–∞—à {username} –Ω–∞—Å—Ç–æ–ª—å–∫–æ –∫—Ä—É—Ç, —á—Ç–æ –¥–∞–∂–µ –±–∏—Ç—ã–µ –ø–∏–∫—Å–µ–ª–∏ –ø–µ—Ä–µ–¥ –Ω–∏–º –∏–∑–≤–∏–Ω—è—é—Ç—Å—è!",
        f"–°–ø–∞—Å–∏–±–æ, {username}, –∑–∞ —Ç–æ, —á—Ç–æ —Ç—ã ‚Äî –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π, –∫—Ç–æ –º–æ–∂–µ—Ç –æ–±—ä—è—Å–Ω–∏—Ç—å, –ø–æ—á–µ–º—É ‚Äò–≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç‚Äô ‚Äî —ç—Ç–æ –Ω–µ –æ—Ç–≤–µ—Ç!",
        f"{username} ‚Äî —ç—Ç–æ –∫–∞–∫ Wi-Fi: –∫–æ–≥–¥–∞ –æ–Ω —Ä—è–¥–æ–º, –≤—Å–µ –ø—Ä–æ—Å—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç. –ò –¥–∞, –º—ã –µ–≥–æ –æ—á–µ–Ω—å —Ü–µ–Ω–∏–º!",
    ]
    return random.choice(mess)


def bad_work(username):
    mess = [
        f"{username} —Ä–µ—à–∏–ª –ø–æ–¥–∞—Ä–∏—Ç—å –Ω–∞–º –Ω–µ–ø–ª–æ—Ö–æ–π –¥—Ä–∞–º–∞—Ç–∏—á–µ—Å–∫–∏–π –º–æ–º–µ–Ω—Ç, –∏–≥—Ä–∞—è '–ü—Ä–æ–ø–∞–ª –≤ –¥–æ–ª–≥–∞—Ö —Å –∑–∞–¥–∞—á–∞–º–∏'!",
        f"–ú—ã —Å–ª—ã—à–∞–ª–∏, —á—Ç–æ {username} –Ω–∞—á–∞–ª –æ—Ç–¥—ã—Ö–∞—Ç—å, –ø–æ—Ç–æ–º—É —á—Ç–æ –æ–Ω –∑–∞–∫–æ–Ω—á–∏–ª –≤—Å–µ –∑–∞–¥–∞—á–∏... –≤ —Å–≤–æ–∏—Ö —Å–Ω–∞—Ö.",
        f"–ú—ã –æ—Ä–≥–∞–Ω–∏–∑—É–µ–º —Å–±–æ—Ä —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è {username} - –∫–∞–∂–¥—ã–π, –∫—Ç–æ –Ω–µ –æ—Ç—Å—Ç–∞–≤–∞–ª –æ—Ç –ø–ª–∞–Ω–∞, –º–æ–∂–µ—Ç —Å–∫–∏–Ω—É—Ç—å—Å—è –Ω–∞ –±–∏–ª–µ—Ç –≤ –±—É–¥—É—â–µ–µ.",
        f"–°—á–∏—Ç–∞–µ–º, —á—Ç–æ {username} –≤–∑—è–ª –Ω–∞ —Å–µ–±—è —Ä–æ–ª—å '–î–≤–∏–≥–∞—Ç–µ–ª—å —ç–∫–æ–Ω–æ–º–∏–∏ –≤—Ä–µ–º–µ–Ω–∏'. –ú—ã –∂–¥–µ–º –µ–≥–æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤!",
        f"–î—É–º–∞—é, {username} —Ä–µ—à–∏–ª —É—Å—Ç—Ä–æ–∏—Ç—å —Ç–∞–π–Ω—ã–π –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å '–ö–∞–∫ —É–≤–µ–ª–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á'.",
        f"–ò–Ω–æ–≥–¥–∞ {username} —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —Ç–∞–∫–∏–º –Ω–µ–≤–∏–¥–∏–º—ã–º, —á—Ç–æ –º—ã –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º, —á—Ç–æ –æ–Ω –∏—Å—Å–ª–µ–¥—É–µ—Ç –Ω–∞—É–∫—É –∫–∞–º—É—Ñ–ª—è–∂–∞.",
        f"–ù–æ–≤–æ–µ —Ö–æ–±–±–∏ {username}: –Ω–µ –∑–∞–Ω–∏–º–∞—Ç—å—Å—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é... ",
        f"–ü–æ–∫–∞ –≤—Å–µ –º—ã —É—á–∏–ª–∏—Å—å —Ä–µ—à–∞—Ç—å –∑–∞–¥–∞—á–∏, {username} –º–∞—Å—Ç–µ—Ä–∏–ª –ø–ª–∞–Ω '–ò—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏—è –∏–∑ —Å–ø–∏—Å–∫–∞ –∑–∞–¥–∞—á'.",
        f"–°–µ–∫—Ä–µ—Ç —É—Å–ø–µ—Ö–∞ {username}: –¥–µ–ª–∞—Ç—å –≤—Å–µ –º–µ–¥–ª–µ–Ω–Ω–µ–µ, —á–µ–º –∫–∞–∂–µ—Ç—Å—è –≤–æ–∑–º–æ–∂–Ω—ã–º. –¢–∞–∫, –Ω–∏–∫—Ç–æ –∏ –Ω–µ –∑–∞–º–µ—Ç–∏—Ç!",
        f"–ï—Å–ª–∏ {username} –±—ã–ª –±—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º —Å–ø—è—â–∏–º, –æ–Ω –±—ã–ª –±—ã –±–æ–≥–∞—Ç. –ù–∞—É—á–∏—Ç–µ—Å—å –º–Ω–æ–≥–æ–º—É, –Ω–∞–±–ª—é–¥–∞—è –∑–∞ –Ω–∏–º!",
        f"–ó–∞–≥–∞–¥–∫–∞ {username}: –ø–æ—á–µ–º—É –æ–Ω –≤—Å–µ–≥–¥–∞ —Ç–∞–∫–æ–π –º–µ–¥–ª–µ–Ω–Ω—ã–π? –û–Ω, –≤–æ–∑–º–æ–∂–Ω–æ, –ø—ã—Ç–∞–µ—Ç—Å—è –ø–æ–±–µ–¥–∏—Ç—å –≤ '–ú–µ–¥–ª–µ–Ω–Ω–æ–º –º–∞—Ä–∞—Ñ–æ–Ω–µ –∑–∞–¥–∞—á'!",
        f"–í–∞–∂–Ω–æ –ø–æ–º–Ω–∏—Ç—å, —á—Ç–æ {username} –æ–±—Ä–∞—Ç–∏–ª –∑–∞–¥–∞—á—É –≤ –∏—Å–∫—É—Å—Å—Ç–≤–æ: –∏—Å–∫—É—Å—Å—Ç–≤–æ –Ω–µ –∑–∞–∫–∞–Ω—á–∏–≤–∞—Ç—å –Ω–∏—á–µ–≥–æ.",
        f"–ï—Å–ª–∏ {username} —É—á–∏–ª—Å—è –±—ã –Ω–∞ —Ñ–∞–∫—É–ª—å—Ç–µ—Ç–µ '–û—Ç—Å—Ä–æ—á–∫–∏ –∏ –æ–ø—Ä–∞–≤–¥–∞–Ω–∏—è', –æ–Ω –±—ã–ª –±—ã –ª—É—á—à–∏–º!",
        f"–ú—ã –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º, —á—Ç–æ {username} —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ –ø–ª–∞–Ω—É: '–ó–∞–≤–∞–ª–∏—Ç—å –≤—Å—ë, —á—Ç–æ–±—ã –ø–æ—Ç–æ–º —á—É–¥–µ—Å–Ω–æ —Å–ø–∞—Å—Ç–∏'.",
        f"–°–µ–∫—Ä–µ—Ç {username}: –æ–Ω —Å—á–∏—Ç–∞–µ—Ç, —á—Ç–æ –ª—É—á—à–∞—è –∑–∞–¥–∞—á–∞ - —ç—Ç–æ –∑–∞–¥–∞—á–∞, –∫–æ—Ç–æ—Ä—É—é –Ω–µ –Ω—É–∂–Ω–æ –≤—ã–ø–æ–ª–Ω—è—Ç—å.",
        f"–ö–∞–∂–µ—Ç—Å—è, {username} –ø—Ä–∏–Ω—è–ª —Ä–µ—à–µ–Ω–∏–µ –ø–æ–π—Ç–∏ –Ω–∞ '–û—Ç–¥—ã—Ö–∞—Ç–µ–ª—å—Å–∫—É—é –û–ª–∏–º–ø–∏–∞–¥—É' –∏ –≤—ã–∏–≥—Ä–∞—Ç—å –∑–æ–ª–æ—Ç—É—é –º–µ–¥–∞–ª—å –≤ –ª–µ–∂–∞–Ω–∏–∏ –Ω–∞ –¥–∏–≤–∞–Ω–µ!",
        f"–ü–æ–∫–∞ –≤—Å–µ —Ç—Ä—É–¥–∏–ª–∏—Å—å, {username} –∏—Å—Å–ª–µ–¥–æ–≤–∞–ª —Ñ–µ–Ω–æ–º–µ–Ω '–ò—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏–µ —Å —Ä–∞–±–æ—á–µ–≥–æ –º–µ—Å—Ç–∞'.",
        f"–°–∞–º—ã–π —Å–ª–æ–∂–Ω—ã–π –≤—ã–∑–æ–≤: –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø–æ–Ω—è—Ç—å, –∫–∞–∫ {username} —Å—á–∏—Ç–∞–µ—Ç, —á—Ç–æ —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ.",
        f"–ï—Å–ª–∏ {username} —É—á–∏–ª—Å—è –±—ã –≤ –®–∫–æ–ª–µ –¢–æ—Ä–º–æ–∑–æ–ª–æ–≥–∏–∏, –æ–Ω –±—ã–ª –±—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–æ–º!",
        f"–°–µ—Ä—å–µ–∑–Ω–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ: –∫–∞–∫ {username} —É–º—É–¥—Ä—è–µ—Ç—Å—è —Å–¥–µ–ª–∞—Ç—å –º–µ–Ω—å—à–µ, —á–µ–º –Ω–∏—á–µ–≥–æ.",
        f"–ú—ã –¥—É–º–∞–ª–∏, {username} - –≥–ª–∞–≤–∞ '–ö–ª—É–±–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –º–∏–Ω—É—Ç—á–∏–∫–∞'. –û–∫–∞–∑–∞–ª–æ—Å—å, –æ–Ω - –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —á–ª–µ–Ω!",
        f"–ü–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è {username}: —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å —á—Ç–æ-—Ç–æ, –Ω—É–∂–Ω–æ –Ω–∞—á–∞—Ç—å —Å–¥–µ–ª—ã–≤–∞—Ç—å —á—Ç–æ-—Ç–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ!",
    ]
    return random.choice(mess)


async def get_stats():
    analyzer = DataAnalyzer(session_maker)
    await analyzer.get_results()
    await analyzer.get_total_open_tickets()

    message, finish = await get_message(analyzer, '—Å–µ–≥–æ–¥–Ω—è')
    message += f'<code>\n\n–û—Ç–∫—Ä—ã—Ç—ã—Ö –∑–∞—è–≤–æ–∫ –æ—Å—Ç–∞–ª–æ—Å—å: {analyzer.total_open[0][0]}\n\n'
    message += f'–°–∞–º–∞—è —Å—Ç–∞—Ä–∞—è –∑–∞—è–≤–∫–∞ {analyzer.total_open[0][1]}</code>'
    logger.info(message)
    logger.info(finish)

    # –µ—Å–ª–∏ —Å–µ–≥–æ–¥–Ω—è –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ
    if datetime.datetime.today().weekday() == 6:
        message, finish = await get_message(analyzer, '–º–µ—Å—è—Ü')
        return message, finish

    # –µ—Å–ª–∏ —Å–µ–≥–æ–¥–Ω—è –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å –º–µ—Å—è—Ü–∞
    today = datetime.date.today()
    is_last_day_of_month = today.day == calendar.monthrange(today.year, today.month)[1]
    if is_last_day_of_month:
        message, finish = await get_message(analyzer, '–º–µ—Å—è—Ü')
        return message, finish

    return message, finish


async def check_new_tickets():
    last_id = load_last_id()
    async with session_maker() as session:
        result = await session.execute(
            select(Ticket).where(
                Ticket.id > last_id,
                Ticket.queue_id.in_([1, 4])).order_by(Ticket.id)
        )
        new_tickets = result.scalars().all()
        if new_tickets:
            for ticket in new_tickets:
                await process_ticket(ticket)
            save_last_id(new_tickets[-1].id)


async def process_ticket(ticket):
    # –°–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–æ–≤–æ–π –∑–∞—è–≤–∫–µ
    logger.info(f"–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–∏–∫–µ—Ç–∞ —Å ID: {ticket.id}")
    logger.debug(ticket)
    message = f"<code>üÜï <b>–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –≤ OTRS</b>\n\nüìÑ <b>–¢–∏–∫–µ—Ç:</b> {ticket.tn}\nüìù <b>–¢–µ–º–∞:</b> {ticket.title}\nüë§ <b>–ö–ª–∏–µ–Ω—Ç:</b> {ticket.customer_user_id}</code>"
    send_message(KafkaTopics.TG_BOT_MSGS.value, {"command": KafkaTopics.OTRS_NEW_TICKET.name, "content": message})


async def process_message(msg):
    # –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ kafka
    logger.info(f"–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è: {msg}")
    if msg["command"] == KafkaTopics.OTRS_STATS.name:
        stats, finish = await get_stats()
        send_message(KafkaTopics.TG_BOT_MSGS.value, {"command": KafkaTopics.OTRS_STATS.name, "content": stats})
        send_message(KafkaTopics.TG_BOT_MSGS.value, {"command": KafkaTopics.OTRS_STATS.name, "content": finish})
    else:
        send_message(KafkaTopics.TG_BOT_MSGS.value, {"command": KafkaTopics.OTRS_STATS.name, "content": "Invalid command"})
